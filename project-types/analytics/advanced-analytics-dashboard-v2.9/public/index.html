<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analytics Dashboard v2.9 - AI Performance Monitoring</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            color: #7f8c8d;
            text-align: center;
            font-size: 1.1rem;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .status-item {
            text-align: center;
        }

        .status-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .status-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 15px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .metric-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .alerts-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-critical {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .alert-warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .alert-info {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .alert-time {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }

        .connected {
            background: #4caf50;
        }

        .disconnected {
            background: #f44336;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .model-selector {
            margin-bottom: 20px;
        }

        .model-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        .time-range-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-range-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-range-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .time-range-btn:hover {
            background: #f8f9fa;
        }

        .time-range-btn.active:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Connecting...</div>
    
    <div class="container">
        <div class="header">
            <h1>üöÄ Advanced Analytics Dashboard v2.9</h1>
            <p>Real-time AI Performance Monitoring & Analytics</p>
        </div>

        <div class="status-bar" id="statusBar">
            <div class="status-item">
                <div class="status-value" id="totalModels">0</div>
                <div class="status-label">Active Models</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="totalRequests">0</div>
                <div class="status-label">Total Requests</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="avgResponseTime">0ms</div>
                <div class="status-label">Avg Response Time</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="avgAccuracy">0%</div>
                <div class="status-label">Avg Accuracy</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="criticalAlerts">0</div>
                <div class="status-label">Critical Alerts</div>
            </div>
        </div>

        <div class="model-selector">
            <select id="modelSelector">
                <option value="">All Models</option>
            </select>
        </div>

        <div class="time-range-selector">
            <button class="time-range-btn active" data-range="3600000">1 Hour</button>
            <button class="time-range-btn" data-range="21600000">6 Hours</button>
            <button class="time-range-btn" data-range="86400000">24 Hours</button>
            <button class="time-range-btn" data-range="604800000">7 Days</button>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>üìä Response Time Trend</h3>
                <div class="chart-container">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üéØ Accuracy Trend</h3>
                <div class="chart-container">
                    <canvas id="accuracyChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>‚ö° Throughput Trend</h3>
                <div class="chart-container">
                    <canvas id="throughputChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>‚ùå Error Rate Trend</h3>
                <div class="chart-container">
                    <canvas id="errorRateChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üíæ Resource Usage</h3>
                <div class="chart-container">
                    <canvas id="resourceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üö® Recent Alerts</h3>
                <div class="alerts-container" id="alertsContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading alerts...
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>üìà Model Performance Metrics</h3>
            <div class="metrics-grid" id="metricsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading metrics...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let charts = {};
        let currentModel = '';
        let currentTimeRange = 3600000; // 1 hour
        let historicalData = [];

        // Initialize dashboard
        function initDashboard() {
            connectWebSocket();
            setupEventListeners();
            initializeCharts();
        }

        // WebSocket connection
        function connectWebSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to server');
                updateConnectionStatus('connected');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateConnectionStatus('disconnected');
            });

            socket.on('initial_data', (data) => {
                console.log('Received initial data:', data);
                updateDashboard(data);
            });

            socket.on('metrics_update', (data) => {
                console.log('Metrics update:', data);
                updateMetrics(data);
            });

            socket.on('alerts_update', (data) => {
                console.log('Alerts update:', data);
                updateAlerts(data.alerts);
            });
        }

        // Update connection status
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = status === 'connected' ? 'Connected' : 'Disconnected';
            statusEl.className = `connection-status ${status}`;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Model selector
            document.getElementById('modelSelector').addEventListener('change', (e) => {
                currentModel = e.target.value;
                updateCharts();
            });

            // Time range buttons
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentTimeRange = parseInt(e.target.dataset.range);
                    loadHistoricalData();
                });
            });
        }

        // Initialize charts
        function initializeCharts() {
            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: 'HH:mm'
                            }
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            };

            // Response Time Chart
            charts.responseTime = new Chart(document.getElementById('responseTimeChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Response Time (ms)',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        ...chartConfig.scales,
                        y: {
                            ...chartConfig.scales.y,
                            title: {
                                display: true,
                                text: 'Response Time (ms)'
                            }
                        }
                    }
                }
            });

            // Accuracy Chart
            charts.accuracy = new Chart(document.getElementById('accuracyChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Accuracy (%)',
                        data: [],
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        ...chartConfig.scales,
                        y: {
                            ...chartConfig.scales.y,
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Accuracy (%)'
                            }
                        }
                    }
                }
            });

            // Throughput Chart
            charts.throughput = new Chart(document.getElementById('throughputChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Throughput (req/s)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        ...chartConfig.scales,
                        y: {
                            ...chartConfig.scales.y,
                            title: {
                                display: true,
                                text: 'Throughput (req/s)'
                            }
                        }
                    }
                }
            });

            // Error Rate Chart
            charts.errorRate = new Chart(document.getElementById('errorRateChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Error Rate (%)',
                        data: [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        ...chartConfig.scales,
                        y: {
                            ...chartConfig.scales.y,
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Error Rate (%)'
                            }
                        }
                    }
                }
            });

            // Resource Usage Chart
            charts.resource = new Chart(document.getElementById('resourceChart'), {
                type: 'doughnut',
                data: {
                    labels: ['CPU Usage', 'Memory Usage'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#3498db', '#e74c3c'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Update dashboard with initial data
        function updateDashboard(data) {
            updateStatusBar(data.summary);
            updateModelSelector(data.models);
            updateAlerts(data.alerts);
            updateMetricsGrid(data.models);
        }

        // Update status bar
        function updateStatusBar(summary) {
            document.getElementById('totalModels').textContent = summary.totalModels || 0;
            document.getElementById('totalRequests').textContent = summary.totalRequests || 0;
            document.getElementById('avgResponseTime').textContent = Math.round(summary.averageResponseTime || 0) + 'ms';
            document.getElementById('avgAccuracy').textContent = Math.round((summary.averageAccuracy || 0) * 100) + '%';
            document.getElementById('criticalAlerts').textContent = summary.criticalAlerts || 0;
        }

        // Update model selector
        function updateModelSelector(models) {
            const selector = document.getElementById('modelSelector');
            selector.innerHTML = '<option value="">All Models</option>';
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.modelId;
                option.textContent = model.modelId;
                selector.appendChild(option);
            });
        }

        // Update metrics
        function updateMetrics(data) {
            if (currentModel && data.modelId !== currentModel) return;
            
            const timestamp = new Date(data.timestamp);
            const metrics = data.metrics;

            // Update charts
            updateChartData('responseTime', timestamp, metrics.responseTime);
            updateChartData('accuracy', timestamp, metrics.accuracy * 100);
            updateChartData('throughput', timestamp, metrics.throughput);
            updateChartData('errorRate', timestamp, metrics.errorRate * 100);

            // Update resource chart
            charts.resource.data.datasets[0].data = [metrics.cpuUsage || 0, metrics.memoryUsage || 0];
            charts.resource.update();

            // Update status bar
            loadSummary();
        }

        // Update chart data
        function updateChartData(chartName, timestamp, value) {
            const chart = charts[chartName];
            if (!chart) return;

            chart.data.datasets[0].data.push({
                x: timestamp,
                y: value
            });

            // Keep only last 100 data points
            if (chart.data.datasets[0].data.length > 100) {
                chart.data.datasets[0].data = chart.data.datasets[0].data.slice(-100);
            }

            chart.update('none');
        }

        // Update alerts
        function updateAlerts(alerts) {
            const container = document.getElementById('alertsContainer');
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="loading">No alerts</div>';
                return;
            }

            container.innerHTML = alerts.slice(-10).map(alert => `
                <div class="alert-item alert-${alert.severity}">
                    <div><strong>${alert.type.replace('_', ' ').toUpperCase()}</strong></div>
                    <div>${alert.message}</div>
                    <div class="alert-time">${new Date(alert.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
        }

        // Update metrics grid
        function updateMetricsGrid(models) {
            const container = document.getElementById('metricsGrid');
            
            if (models.length === 0) {
                container.innerHTML = '<div class="loading">No models available</div>';
                return;
            }

            container.innerHTML = models.map(model => {
                const metrics = model.metrics;
                return `
                    <div class="metric-item">
                        <div class="metric-value">${metrics.responseTime || 0}ms</div>
                        <div class="metric-label">${model.modelId} - Response Time</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${Math.round((metrics.accuracy || 0) * 100)}%</div>
                        <div class="metric-label">${model.modelId} - Accuracy</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${metrics.throughput || 0}</div>
                        <div class="metric-label">${model.modelId} - Throughput</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${Math.round((metrics.errorRate || 0) * 100)}%</div>
                        <div class="metric-label">${model.modelId} - Error Rate</div>
                    </div>
                `;
            }).join('');
        }

        // Load historical data
        async function loadHistoricalData() {
            try {
                const url = `/api/historical?timeRange=${currentTimeRange}${currentModel ? `&modelId=${currentModel}` : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                historicalData = data;
                updateCharts();
            } catch (error) {
                console.error('Error loading historical data:', error);
            }
        }

        // Update charts with historical data
        function updateCharts() {
            const filteredData = currentModel ? 
                historicalData.filter(d => d.modelId === currentModel) : 
                historicalData;

            // Group data by time and calculate averages
            const groupedData = {};
            filteredData.forEach(d => {
                const time = new Date(d.timestamp);
                const key = time.getTime();
                
                if (!groupedData[key]) {
                    groupedData[key] = {
                        timestamp: time,
                        responseTime: [],
                        accuracy: [],
                        throughput: [],
                        errorRate: []
                    };
                }
                
                groupedData[key].responseTime.push(d.responseTime || 0);
                groupedData[key].accuracy.push(d.accuracy || 0);
                groupedData[key].throughput.push(d.throughput || 0);
                groupedData[key].errorRate.push(d.errorRate || 0);
            });

            // Update each chart
            Object.keys(charts).forEach(chartName => {
                if (chartName === 'resource') return;
                
                const chart = charts[chartName];
                chart.data.datasets[0].data = Object.values(groupedData).map(d => ({
                    x: d.timestamp,
                    y: chartName === 'accuracy' ? 
                        d.accuracy.reduce((a, b) => a + b, 0) / d.accuracy.length * 100 :
                        chartName === 'errorRate' ?
                        d.errorRate.reduce((a, b) => a + b, 0) / d.errorRate.length * 100 :
                        chartName === 'responseTime' ?
                        d.responseTime.reduce((a, b) => a + b, 0) / d.responseTime.length :
                        d.throughput.reduce((a, b) => a + b, 0) / d.throughput.length
                }));
                
                chart.update();
            });
        }

        // Load summary data
        async function loadSummary() {
            try {
                const response = await fetch('/api/summary');
                const summary = await response.json();
                updateStatusBar(summary);
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
