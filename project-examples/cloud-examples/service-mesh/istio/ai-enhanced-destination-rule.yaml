apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: ai-enhanced-destination-rule
  namespace: manager-agent-ai
  labels:
    app: manager-agent-ai
    version: v2.9
    ai-enhanced: "true"
spec:
  host: api-gateway-service
  trafficPolicy:
    # AI-Enhanced Load Balancing
    loadBalancer:
      simple: LEAST_CONN
      consistentHash:
        httpHeaderName: "x-user-id"
        minimumRingSize: 1024
        useSourceIp: true
    # Advanced Connection Pool Management
    connectionPool:
      tcp:
        maxConnections: 200
        connectTimeout: 30s
        tcpKeepalive:
          time: 7200s
          interval: 75s
          probes: 9
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 200
        maxRequestsPerConnection: 10
        maxRetries: 3
        h2UpgradePolicy: UPGRADE
        useClientProtocol: true
        idleTimeout: 300s
        maxIdleTime: 300s
    # Intelligent Circuit Breaking
    circuitBreaker:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30
      splitExternalLocalOriginErrors: true
      consecutiveGatewayErrors: 3
    # Outlier Detection with AI
    outlierDetection:
      consecutiveGatewayErrors: 3
      consecutive5xxErrors: 3
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30
      splitExternalLocalOriginErrors: true
      enforcingConsecutive5xx: 100
      enforcingConsecutiveGatewayErrors: 100
      enforcingSuccessRate: 100
      successRateMinimumHosts: 5
      successRateRequestVolume: 100
      successRateStdevFactor: 1900
    # TLS Configuration
    tls:
      mode: ISTIO_MUTUAL
      sni: api-gateway-service.manager-agent-ai.svc.cluster.local
      subjectAltNames:
      - "spiffe://cluster.local/ns/manager-agent-ai/sa/api-gateway"
    # Port-level Configuration
    portLevelSettings:
    - port:
        number: 3000
      tls:
        mode: ISTIO_MUTUAL
      connectionPool:
        tcp:
          maxConnections: 100
          connectTimeout: 15s
        http:
          http1MaxPendingRequests: 50
          http2MaxRequests: 100
          maxRequestsPerConnection: 5
      circuitBreaker:
        consecutiveErrors: 3
        interval: 20s
        baseEjectionTime: 20s
        maxEjectionPercent: 30
      outlierDetection:
        consecutiveGatewayErrors: 2
        interval: 20s
        baseEjectionTime: 20s
        maxEjectionPercent: 30

---
# Subset Definitions for AI-Enhanced Routing
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: api-gateway-subsets
  namespace: manager-agent-ai
spec:
  host: api-gateway-service
  subsets:
  # AI-Optimized Subset
  - name: ai-optimized
    labels:
      version: ai-optimized
      ai-enhanced: "true"
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
      connectionPool:
        tcp:
          maxConnections: 150
          connectTimeout: 20s
        http:
          http1MaxPendingRequests: 75
          http2MaxRequests: 150
          maxRequestsPerConnection: 8
      circuitBreaker:
        consecutiveErrors: 3
        interval: 25s
        baseEjectionTime: 25s
        maxEjectionPercent: 40
      outlierDetection:
        consecutiveGatewayErrors: 2
        interval: 25s
        baseEjectionTime: 25s
        maxEjectionPercent: 40

  # High Performance Subset
  - name: high-performance
    labels:
      version: high-performance
      performance-tier: "high"
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
      connectionPool:
        tcp:
          maxConnections: 300
          connectTimeout: 10s
        http:
          http1MaxPendingRequests: 150
          http2MaxRequests: 300
          maxRequestsPerConnection: 15
      circuitBreaker:
        consecutiveErrors: 2
        interval: 15s
        baseEjectionTime: 15s
        maxEjectionPercent: 20
      outlierDetection:
        consecutiveGatewayErrors: 1
        interval: 15s
        baseEjectionTime: 15s
        maxEjectionPercent: 20

  # Geographic Subsets
  - name: us-east
    labels:
      region: us-east
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
      connectionPool:
        tcp:
          maxConnections: 100
          connectTimeout: 25s
        http:
          http1MaxPendingRequests: 50
          http2MaxRequests: 100
          maxRequestsPerConnection: 10

  - name: eu-west
    labels:
      region: eu-west
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
      connectionPool:
        tcp:
          maxConnections: 100
          connectTimeout: 30s
        http:
          http1MaxPendingRequests: 50
          http2MaxRequests: 100
          maxRequestsPerConnection: 10

  # Mobile Optimized Subset
  - name: mobile-optimized
    labels:
      version: mobile
      optimization: "mobile"
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
      connectionPool:
        tcp:
          maxConnections: 200
          connectTimeout: 20s
        http:
          http1MaxPendingRequests: 100
          http2MaxRequests: 200
          maxRequestsPerConnection: 12
      circuitBreaker:
        consecutiveErrors: 4
        interval: 30s
        baseEjectionTime: 30s
        maxEjectionPercent: 30

  # Version Subsets
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
      connectionPool:
        tcp:
          maxConnections: 100
          connectTimeout: 30s
        http:
          http1MaxPendingRequests: 50
          http2MaxRequests: 100
          maxRequestsPerConnection: 10

  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
      connectionPool:
        tcp:
          maxConnections: 100
          connectTimeout: 30s
        http:
          http1MaxPendingRequests: 50
          http2MaxRequests: 100
          maxRequestsPerConnection: 10

  # Canary Subset
  - name: canary
    labels:
      version: canary
      stage: "canary"
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
      connectionPool:
        tcp:
          maxConnections: 50
          connectTimeout: 30s
        http:
          http1MaxPendingRequests: 25
          http2MaxRequests: 50
          maxRequestsPerConnection: 5
      circuitBreaker:
        consecutiveErrors: 2
        interval: 20s
        baseEjectionTime: 20s
        maxEjectionPercent: 50

  # Stable Subset
  - name: stable
    labels:
      version: stable
      stage: "stable"
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
      connectionPool:
        tcp:
          maxConnections: 200
          connectTimeout: 30s
        http:
          http1MaxPendingRequests: 100
          http2MaxRequests: 200
          maxRequestsPerConnection: 10
      circuitBreaker:
        consecutiveErrors: 5
        interval: 30s
        baseEjectionTime: 30s
        maxEjectionPercent: 30

  # Experiment Subsets
  - name: experiment-a
    labels:
      version: experiment-a
      experiment: "A"
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
      connectionPool:
        tcp:
          maxConnections: 50
          connectTimeout: 30s
        http:
          http1MaxPendingRequests: 25
          http2MaxRequests: 50
          maxRequestsPerConnection: 5

  - name: experiment-b
    labels:
      version: experiment-b
      experiment: "B"
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
      connectionPool:
        tcp:
          maxConnections: 50
          connectTimeout: 30s
        http:
          http1MaxPendingRequests: 25
          http2MaxRequests: 50
          maxRequestsPerConnection: 5

  # Admin Subset
  - name: admin
    labels:
      version: admin
      tier: "admin"
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
      connectionPool:
        tcp:
          maxConnections: 20
          connectTimeout: 60s
        http:
          http1MaxPendingRequests: 10
          http2MaxRequests: 20
          maxRequestsPerConnection: 5
      circuitBreaker:
        consecutiveErrors: 1
        interval: 60s
        baseEjectionTime: 60s
        maxEjectionPercent: 10

  # Default Subset
  - name: default
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: LEAST_CONN
      connectionPool:
        tcp:
          maxConnections: 100
          connectTimeout: 30s
        http:
          http1MaxPendingRequests: 50
          http2MaxRequests: 100
          maxRequestsPerConnection: 10
      circuitBreaker:
        consecutiveErrors: 3
        interval: 30s
        baseEjectionTime: 30s
        maxEjectionPercent: 30
      outlierDetection:
        consecutiveGatewayErrors: 3
        interval: 30s
        baseEjectionTime: 30s
        maxEjectionPercent: 30
